name: Upload Assets to R2

on:
  push:
    branches:
      - main
    paths:
      - 'public/video/**'
      - 'public/images/**'
      - 'public/docs/**'
  workflow_dispatch: # Allow manual trigger
    inputs:
      force_upload:
        description: 'Force upload all assets (not just changed ones)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  upload-assets:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          lfs: true # Pull Git LFS files
      
      - name: Pull LFS files
        run: |
          git lfs pull
          echo "‚úÖ Git LFS files pulled successfully"
          # Verify video files are actual files, not pointers
          for file in public/video/*.mp4 public/video/*.webm; do
            if [ -f "$file" ]; then
              size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null)
              if [ "$size" -lt 1000 ]; then
                echo "‚ùå Warning: $file appears to be an LFS pointer (size: $size bytes)"
                exit 1
              else
                echo "‚úÖ $file: $(($size / 1024 / 1024))MB"
              fi
            fi
          done
        
      - name: Check R2 availability
        id: r2-check
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          python - <<'PY'
          import json
          import os
          import sys
          import urllib.error
          import urllib.request

          account = os.environ["CLOUDFLARE_ACCOUNT_ID"]
          token = os.environ["CLOUDFLARE_API_TOKEN"]
          url = f"https://api.cloudflare.com/client/v4/accounts/{account}/r2/buckets"
          req = urllib.request.Request(
              url,
              headers={
                  "Authorization": f"Bearer {token}",
                  "Content-Type": "application/json",
              },
          )

          available = False
          note = ""

          try:
              with urllib.request.urlopen(req) as resp:
                  data = json.load(resp)
          except urllib.error.HTTPError as exc:
              body = exc.read()
              try:
                  data = json.loads(body)
              except Exception:
                  note = body.decode(errors="ignore")
                  data = None
              if exc.code == 403 and data:
                  errors = data.get("errors") or []
                  if any(err.get("code") == 10042 for err in errors):
                      note = errors[0].get("message", note)
                  else:
                      print(body.decode(), file=sys.stderr)
                      raise
              else:
                  print(body.decode(), file=sys.stderr)
                  raise
          else:
              available = bool(data.get("success"))
              if not available:
                  errors = data.get("errors") or []
                  if errors:
                      note = errors[0].get("message", "")

          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as fh:
              fh.write(f"available={'true' if available else 'false'}\n")
              if note:
                  fh.write(f"note={note}\n")

          if note:
              print(f"::notice::{note}")

          if not available and not note:
              print("Unable to verify R2 availability", file=sys.stderr)
              sys.exit(1)
          PY

      - name: Skip R2 upload (R2 disabled)
        if: steps.r2-check.outputs.available != 'true'
        run: |
          echo "‚ö†Ô∏è R2 is not enabled for this account yet; skipping asset synchronization."

      - name: Setup Node.js
        if: steps.r2-check.outputs.available == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install Wrangler
        if: steps.r2-check.outputs.available == 'true'
        run: npm install -g wrangler
        
      - name: Upload video assets to R2
        if: steps.r2-check.outputs.available == 'true'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "üì§ Uploading video assets to R2..."
          
          # Upload all video files
          for file in public/video/*.{mp4,webm,vtt,srt}; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              echo "Uploading $filename..."
              wrangler r2 object put "justevery-assets/video/$filename" --file="$file" --remote --multipart
            fi
          done
          
          # Upload images if they exist
          if [ -d "public/images" ]; then
            for file in public/images/*; do
              if [ -f "$file" ]; then
                filename=$(basename "$file")
                echo "Uploading image: $filename..."
                  wrangler r2 object put "justevery-assets/images/$filename" --file="$file" --remote --multipart
              fi
            done
          fi
          
      - name: Verify uploads
        if: steps.r2-check.outputs.available == 'true'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "üîç Verifying R2 uploads..."
          
          # Test a key file
          if wrangler r2 object get "justevery-assets/video/promo-854w.mp4" --remote --pipe > /dev/null 2>&1; then
            echo "‚úÖ R2 uploads verified successfully"
          else
            echo "‚ùå Failed to verify R2 uploads"
            exit 1
          fi
